<!--
Description: Component template showing activity details with navigation buttons, a searchable and paginated volunteers table, and an actions panel including attendance marking and certificate generation. ARIA attributes are added for improved accessibility.
Author: Your Name
-->

<!-- HEADER -->
<div class="details-header" *ngIf="activity" role="banner" aria-label="Activity navigation header">
  <div class="the-buttons" *ngIf="activity" role="navigation" aria-label="Activity detail navigation buttons">
    <button mat-icon-button [routerLink]="['/dashboard']" matTooltip="Back to Dashboard" aria-label="Back to dashboard">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <button mat-button [routerLink]="['/activity', activity.id]" aria-current="page">Details</button>
    <button mat-button [routerLink]="['/registered', activity.id]">Registered Volunteers</button>
    <button mat-icon-button aria-label="Edit activity">
      <mat-icon>edit</mat-icon>
    </button>
  </div>
</div>

<div class="details-container" *ngIf="activity" role="main" aria-labelledby="activity-details-title">
  <div class="details-subpanels">

    <!-- Panel con búsqueda + tabla -->
    <mat-card class="volunteers-panel mat-elevation-z8" role="region" aria-labelledby="volunteers-panel-title">
      <mat-card-header>
        <mat-form-field appearance="outline" style="width: 100%;">
          <mat-label id="volunteers-search-label">Buscar voluntario por nombre</mat-label>
          <input matInput type="text" [(ngModel)]="searchText" (ngModelChange)="applyFilter()"
                 aria-describedby="volunteers-search-description" aria-label="Search volunteer by name" />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        <span id="volunteers-search-description" class="sr-only"></span>
      </mat-card-header>

      <mat-card-content>
        <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" *ngIf="dataSource.data.length > 0" aria-label="Volunteers table">

          <!-- Columns defined here with appropriate headers and cells -->

          <ng-container matColumnDef="fullName">
            <th mat-header-cell *matHeaderCellDef scope="col"> Nombre </th>
            <td mat-cell *matCellDef="let volunteer"> {{volunteer.fullName}} </td>
          </ng-container>

          <ng-container matColumnDef="age">
            <th mat-header-cell *matHeaderCellDef scope="col"> Edad </th>
            <td mat-cell *matCellDef="let volunteer"> {{volunteer.age}} </td>
          </ng-container>

          <ng-container matColumnDef="profession">
            <th mat-header-cell *matHeaderCellDef scope="col"> Profesión </th>
            <td mat-cell *matCellDef="let volunteer"> {{volunteer.profession}} </td>
          </ng-container>

          <ng-container matColumnDef="registrationDate">
            <th mat-header-cell *matHeaderCellDef scope="col"> Fecha de inscripción </th>
            <td mat-cell *matCellDef="let volunteer"> {{volunteer.registrationDate | date:'shortDate'}} </td>
          </ng-container>

          <ng-container matColumnDef="registrationStatus">
            <th mat-header-cell *matHeaderCellDef scope="col"> Estado </th>
            <td mat-cell *matCellDef="let volunteer">
              {{ volunteer.registration?.status | titlecase }}
            </td>
          </ng-container>

          <ng-container matColumnDef="registrationAttendance">
            <th mat-header-cell *matHeaderCellDef scope="col"> Asistencia </th>
            <td mat-cell *matCellDef="let volunteer">
              {{ volunteer.registration?.attendance ? 'Sí' : 'No' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="attendanceCheckbox">
            <th mat-header-cell *matHeaderCellDef scope="col"> Asistió </th>
            <td mat-cell *matCellDef="let volunteer">
              <mat-checkbox
                [checked]="attendanceMarked[volunteer.registrationId]"
                (change)="onAttendanceChange(volunteer.registrationId, $event.checked)"
                aria-label="Mark attendance for {{volunteer.fullName}}">
              </mat-checkbox>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns" style="cursor: default;"></tr>
        </table>

        <!-- Paginador -->
        <mat-paginator [pageSizeOptions]="[7]" showFirstLastButtons aria-label="Volunteers table pagination"></mat-paginator>

        <!-- Mensaje cuando no hay datos -->
        <p *ngIf="dataSource.data.length === 0" role="alert" aria-live="polite">
          No hay voluntarios registrados para esta actividad.
        </p>
      </mat-card-content>
    </mat-card>

    <!-- Subpanel de acciones -->
    <div class="volunteers-actions-subpanel mat-elevation-z2" style="padding: 16px; display: flex; flex-direction: column; gap: 20px; max-width: 320px;" role="region" aria-label="Volunteer actions panel">
      <!-- Botón Enviar notificación -->
      <button mat-stroked-button color="primary" style="justify-content: flex-start;" matTooltip="Enviar mensaje a voluntarios" aria-label="Send notification to volunteers">
        <mat-icon style="margin-right: 8px;">notifications_active</mat-icon>
        Enviar notificación
      </button>
      <p style=" font-size: 0.9rem; color: rgba(0,0,0,0.6);">
        Toca aquí para enviar un mensaje a los voluntarios de esta actividad. Útil para compartir información o recordatorios.
      </p>

      <button mat-stroked-button
              [color]="isAttendanceMode ? 'accent' : 'primary'"
              style="justify-content: flex-start;"
              matTooltip="Registrar asistencia"
              (click)="toggleAttendanceMode()"
              [attr.aria-pressed]="isAttendanceMode"
              aria-label="Toggle attendance marking mode">
        <mat-icon style="margin-right: 8px;">check_circle</mat-icon>
        {{ isAttendanceMode ? 'Guardar asistencia' : 'Marcar asistencia' }}
      </button>
      <p style="font-size: 0.9rem; color: rgba(0,0,0,0.6);">
        {{ isAttendanceMode
        ? 'Presiona nuevamente para guardar los registros de asistencia.'
        : 'Presiona para registrar quiénes asistieron hoy a la actividad. ¡Lleva un control fácil!' }}
      </p>

      <!-- Botón Crear certificados -->
      <button mat-stroked-button color="warn"
              (click)="generateCertificates()"
              style="justify-content: flex-start;"
              matTooltip="Generar certificados"
              aria-label="Generate certificates">
        <mat-icon style="margin-right: 8px;">emoji_events</mat-icon>
        Crear certificados
      </button>
      <p style=" font-size: 0.9rem; color: rgba(0,0,0,0.6);">
        ¿Quieres reconocer a tus voluntarios? Toca para generar certificados de participación.
      </p>

      <!-- Botón Abrir inscripciones -->
      <button mat-stroked-button color="primary" style="justify-content: flex-start;" matTooltip="Permitir inscripciones" aria-label="Open registrations">
        <mat-icon style="margin-right: 8px;">person_add</mat-icon>
        Abrir inscripciones
      </button>
      <p style=" font-size: 0.9rem; color: rgba(0,0,0,0.6);">
        ¿Necesitas más voluntarios? Presiona para permitir que más personas se unan a esta actividad.
      </p>
    </div>

  </div>
</div>
